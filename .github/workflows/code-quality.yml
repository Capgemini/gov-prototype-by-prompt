name: Code quality checks

permissions:
    contents: read
    security-events: write

on:
    workflow_dispatch:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    setup:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Cache node modules
              id: cache-nodemodules
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
                  lookup-only: true
            - name: Set up Node.js
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version-file: package.json
            - name: Upgrade npm to v11
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              run: npm install -g "npm@>=11.6.4 <12"
            - name: Log node versions
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              run: node --version && npm --version
            - name: Install dependencies
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              run: npm ci --ignore-scripts

    eslint:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Cache node modules
              id: cache-nodemodules
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
            - name: Set up Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version-file: package.json
            - name: Upgrade npm to v11
              run: npm install -g "npm@>=11.6.4 <12"
            - name: Log node versions
              run: node --version && npm --version
            - name: Install dependencies
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              run: npm ci --ignore-scripts

            - name: Run ESLint
              run: npm run lint -- --max-warnings=0

    jest-unit-tests:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Cache node modules
              id: cache-nodemodules
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
            - name: Set up Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version-file: package.json
            - name: Upgrade npm to v11
              run: npm install -g "npm@>=11.6.4 <12"
            - name: Log node versions
              run: node --version && npm --version
            - name: Install dependencies
              if: steps.cache-nodemodules.outputs.cache-hit != 'true'
              run: npm ci --ignore-scripts

            - name: Run tests with coverage
              run: npm run test -- --coverage --silent --maxWorkers=1

    npm-audit:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                working-directory: ['', './data/zip-download/']
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Set up Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version-file: ${{ matrix.working-directory }}package.json
            - name: Upgrade npm to v11
              run: npm install -g "npm@>=11.6.4 <12"
            - name: Log node versions
              run: node --version && npm --version

            - name: Run npm audit with moderate threshold
              working-directory: ${{ matrix.working-directory }}
              run: npm audit --audit-level=moderate

    snyk-scan:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                target-file:
                    [
                        './package-lock.json',
                        './data/zip-download/package-lock.json',
                    ]
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Run Snyk Monitor to check for vulnerabilities
              uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04 # v1.0.0
              continue-on-error: true # To make sure that future steps get called
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --file=${{ matrix.target-file }} --project-name=${{ matrix.target-file }}
                  command: monitor
            - name: Run Snyk Test to check for vulnerabilities
              uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04 # v1.0.0
              continue-on-error: true # To make sure that future steps get called
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --file=${{ matrix.target-file }} --project-name=${{ matrix.target-file }} --sarif-file-output=snyk.sarif
                  command: test
            - name: Upload result to GitHub Code Scanning
              uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
              with:
                  sarif_file: snyk.sarif
