{% extends "template.njk" %}

{% block pageTitle %}
  Password required â€“ Gov Prototype by Prompt
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">This prototype is protected by a password</h1>
      <p class="govuk-body">You need to enter a password to access this live prototype.</p>
      <p class="govuk-body">If you have a staff account, you can <a href="/user/sign-in">sign in</a>.</p>
      <form id="passwordForm" class="govuk-form-group govuk-!-margin-0" novalidate>
        {{ govukPasswordInput({
          classes: "govuk-input--width-20",
          label: {
              text: "Confirm password"
          },
          name: "password",
          id: "password",
          autocomplete: "off"
        }) }}
        <div class="govuk-button-group">
          {{ govukButton({
            id: 'passwordButton',
            text: "Access prototype",
            type: "submit",
            preventDoubleClick: true
          }) }}
        </div>
      </form>
    </div>
    <div class="govuk-grid-column-one-third">
      {{ govukErrorSummary({
        classes: "govuk-!-margin-bottom-7 display-none",
        titleText: "There was a problem",
        descriptionHtml: "Check the form below."
      }) }}
    </div>
  </div>
{% endblock %}

{% block bodyEnd %}
  {# Run JavaScript at end of the <body>, to avoid blocking the initial render. #}
  {{ super() }}
  <script>
    // Reload the page if the user navigates back
    // This makes sure the submit button is re-enabled
    window.addEventListener("pageshow", function(event) {
      const historyTraversal = event.persisted || 
                            (typeof window.performance != "undefined" && 
                            window.performance.navigation.type === 2);
      if (historyTraversal) {
        window.location.reload();
      }
    });

    document.addEventListener('DOMContentLoaded', async function() {

      const passwordForm = document.getElementById('passwordForm');
      const passwordButton = document.getElementById('passwordButton');
      const errorSummary = document.getElementsByClassName("govuk-error-summary")[0];
      const errorDescription = document.getElementsByClassName("govuk-error-summary__body")[0];

      // Handle async form submission
      passwordForm.addEventListener('submit', async function(event) {

        // Prevent the default form submission
        event.preventDefault();

        // Show processing state
        passwordButton.disabled = true;
        passwordButton.textContent = 'Processing...';
        
        // Request to submit the password
        const data = {
          password: document.getElementById('password').value, 
        };
        fetch('/prototype/{{ prototypeId }}/password', {
          method: 'POST',
          body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            },
          credentials: 'include'
        }).then(async response => {
          const responseJson = await response.json();
          // If response is OK, redirect to the prototype page, otherwise show error
          if (response.ok) {
            window.location.href = responseJson.url;
          } else {
            throw new Error(responseJson.message ?? `${response.status} ${response.statusText}`);
          }
        }).catch(err => {
          errorSummary.classList.remove('display-none');
          errorDescription.innerHTML =`${err.message}`;
          passwordButton.disabled = false;
          passwordButton.textContent = 'Access prototype';
        });
      });
    });
  </script>
{% endblock %}